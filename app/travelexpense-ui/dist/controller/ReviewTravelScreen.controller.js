sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox","sap/ui/model/odata/v4/ODataModel"],function(e,t,s){"use strict";return e.extend("travel.travelexpenseui.controller.ReviewTravelScreen",{onInit:function(){this.getOwnerComponent().getRouter().getRoute("ReviewTravelScreen").attachPatternMatched(this._onRouteMatched,this)},onPreviousStep:function(){var e=sap.ui.core.routing.History.getInstance();var t=e.getPreviousHash();if(t!==undefined){window.history.go(-1)}else{this.getOwnerComponent().getRouter().navTo("RouteCreateTravelRequest",true)}},_onRouteMatched:function(e){this.travelId=e.getParameter("arguments").travelId;console.log("Loaded Travel ID in _onRouteMatched :",this.travelId);if(this.travelId!=="-"){this.getView().setBusy(true);this.byId("id_saveDraftRadio").setEnabled(false);this.byId("id_saveAndApproveRadio").setEnabled(false);this.byId("id_ApproveRadio").setEnabled(true);this.byId("id_ApproveRadio").setSelected(true);this.selectedOption="Approve";const e=this.byId("saveAndProceed");e.setText("Send for Approval");const t=this.getOwnerComponent().getModel();const s=t.bindContext(`/TravelRequests(${this.travelId})`);s.requestObject().then(e=>{const t=new sap.ui.model.json.JSONModel(e);this.getOwnerComponent().setModel(t,"travelData");console.log(e);const s=e.Approvedstatus;console.log("Approvedstatus "+s);console.log("status "+e.status);var a=this.byId("id_ApprovedText");var r=this.byId("id_Approvedstatus");var o=this.byId("id_ApprovedText_2");var i=this.byId("id_Approvedstatus_2");if(s==="Draft"||s===undefined||s===null||s===""){this.byId("finalActionBlock").setVisible(true);this.byId("txt_description").setText("Kindly review the information of this travel request before proceeding.");a.removeStyleClass("stepCircleCurrent stepCircleDisabled stepCircleActive");r.removeStyleClass("stepTextCurrent stepTextDisabled stepTextActive");o.removeStyleClass("stepCircleCurrent stepCircleDisabled stepCircleActive");i.removeStyleClass("stepTextCurrent stepTextDisabled stepTextActive");a.addStyleClass("stepCircleDisabled");r.addStyleClass("stepTextDisabled");o.addStyleClass("stepCircleCurrent");i.addStyleClass("stepTextCurrent")}else{this.byId("finalActionBlock").setVisible(false);this.byId("txt_description").setText("Below are the details of your selected travel request.");if(s==="Approved"||s==="Rejected"){a.removeStyleClass("stepCircleCurrent stepCircleDisabled stepCircleActive");r.removeStyleClass("stepTextCurrent stepTextDisabled stepTextActive");o.removeStyleClass("stepCircleCurrent stepCircleDisabled stepCircleActive");i.removeStyleClass("stepTextCurrent stepTextDisabled stepTextActive");a.addStyleClass("stepCircleActive");r.addStyleClass("stepTextActive");o.addStyleClass("stepCircleActive");i.addStyleClass("stepTextActive")}else{a.removeStyleClass("stepCircleCurrent stepCircleDisabled stepCircleActive");r.removeStyleClass("stepTextCurrent stepTextDisabled stepTextActive");o.removeStyleClass("stepCircleCurrent stepCircleDisabled stepCircleActive");i.removeStyleClass("stepTextCurrent stepTextDisabled stepTextActive");a.addStyleClass("stepCircleDisabled");r.addStyleClass("stepTextDisabled");o.addStyleClass("stepCircleCurrent");i.addStyleClass("stepTextCurrent")}}this.getView().setBusy(false)}).catch(e=>{console.error("Failed to fetch specific travel request:",e);sap.m.MessageBox.error("Error fetching data.")})}else{const e=this.getOwnerComponent().getModel("travelData");this.byId("id_saveDraftRadio").setEnabled(true);this.byId("id_saveAndApproveRadio").setEnabled(true);this.byId("id_ApproveRadio").setEnabled(false);this.byId("id_saveAndApproveRadio").setSelected(true);this.selectedOption="SaveApprove";const t=this.byId("saveAndProceed");t.setText("Save and Send for Approval");this.byId("finalActionBlock").setVisible(true)}const t=this.getOwnerComponent().getModel("travelData");console.log("travelData -----------------");console.log(t);const s=t.getProperty("/startDate")},onActionSelect:function(e){const t=e.getParameter("selectedIndex");const s=this.byId("saveAndProceed");if(t===0){s.setText("Save Draft");this.selectedOption="draft"}else if(t===1){s.setText("Save and Send for Approval");this.selectedOption="SaveApprove"}else{s.setText("Send for Approval");this.selectedOption="Approve"}},onSaveAndApprove:async function(){const e=this.getOwnerComponent().getModel("travelData");const t=e.getProperty("/startDate");const s=e.getProperty("/endDate");var a=e.getProperty("/departure");var r=e.getProperty("/arrival");const o=e.getProperty("/postingDate");const i=e.getProperty("/selfTravel");const l=e.getProperty("/placeOfVisit");var n=e.getProperty("/estimatedCost");var d=e.getProperty("/travelType");var p=e.getProperty("/purposeOfTravel");const v=e.getProperty("/additionalTravellers");const c=e.getProperty("/advances");const u=e.getProperty("/costAssignment");var f=crypto.randomUUID();console.log("estimatedCosts-- 114");console.log(n);if(this.selectedOption==="Approve"){this.getView().setBusy(true);var g=this.getView().getModel();const e=this.travelId;const f=this.getView();var y=g.bindContext("/TravelRequests('"+this.travelId+"')",undefined,{$$updateGroupId:"travelUpdateGroup"});y.requestObject().then(function(){var h=y.getBoundContext();if(h){h.setProperty("status","Approved");h.setProperty("Approvedstatus","Awaiting Approval");g.submitBatch("travelUpdateGroup").then(function(){const g={id:e,employee:"EMP001",startdate:t,enddate:s,postingdate:o,selftravel:i,placeofvisit:l,estimatedcost:n,action:"1",createdat:(new Date).toISOString(),departure:a,arrival:r,traveltype:d,purposeoftravel:p,additionaltravellers:v,advances:c,costassignment:u,status:"Approved"};console.log("travelData sent for approval ------------------");console.log(g);$.ajax({url:"/odata/v4/travel/startTravelWorkflow",method:"POST",contentType:"application/json",data:JSON.stringify({travelData:JSON.stringify(g)}),success:function(e){sap.m.MessageToast.show("Travel request "+this.travelId+" is send for approval.");f.setBusy(false);this.onPreviousStep()},error:function(e,t,s){sap.m.MessageBox.error("Failed to start workflow: "+e.responseText);f.setBusy(false)}})}).catch(function(e){sap.m.MessageBox.error("Failed to update status: "+e.message)})}else{this.getView().setBusy(false);sap.m.MessageBox.error("No bound context found for Travel ID "+this.travelId)}})}else if(this.selectedOption==="draft"){this.getView().setBusy(true);var g=this.getView().getModel();var h=g.bindList("/TravelRequests",undefined,undefined,undefined,{$$updateGroupId:"travelGroup"});h.create({ID:f,employee:"EMP001",startDate:t,endDate:s,postingDate:o,selfTravel:i,placeOfVisit:l,estimatedCost:n,action:1,createdAt:(new Date).toISOString(),departure:a,arrival:r,travelType:d,purposeOfTravel:p,additionalTravellers:v,advances:c,costAssignment:u,status:"Draft"});g.submitBatch("travelGroup").then(()=>{if(this.selectedOption==="draft"){sap.m.MessageToast.show("Travel request "+f+" is saved successfully.")}else if(this.selectedOption==="SaveApprove"){sap.m.MessageToast.show("Travel request "+f+" is saved successfully and send for approval.")}else if(this.selectedOption==="Approve"){sap.m.MessageToast.show("Travel request "+f+" is send for approval.")}}).catch(e=>{sap.m.MessageBox.error("Error saving travel request: "+e.message)}).finally(()=>{this.getView().setBusy(false);this.onPreviousStep()})}else if(this.selectedOption==="SaveApprove"){this.getView().setBusy(true);var g=this.getView().getModel();var h=g.bindList("/TravelRequests",undefined,undefined,undefined,{$$updateGroupId:"travelGroup"});h.create({ID:f,employee:"EMP001",startDate:t,endDate:s,postingDate:o,selfTravel:i,placeOfVisit:l,estimatedCost:n,action:1,createdAt:(new Date).toISOString(),departure:a,arrival:r,travelType:d,purposeOfTravel:p,additionalTravellers:v,advances:c,costAssignment:u,status:"Approved",Approvedstatus:"Awaiting Approval"});g.submitBatch("travelGroup").then(()=>{const e={id:f,employee:"EMP001",startdate:t,enddate:s,postingdate:o,selftravel:i,placeofvisit:l,estimatedcost:n,action:"1",createdat:(new Date).toISOString(),departure:a,arrival:r,traveltype:d,purposeoftravel:p,additionaltravellers:v,advances:c,costassignment:u,status:"Approved"};$.ajax({url:"/odata/v4/travel/startTravelWorkflow",method:"POST",contentType:"application/json",data:JSON.stringify({travelData:JSON.stringify(e)}),success:function(e){sap.m.MessageToast.show("Travel request "+f+" is saved and send for approval.")},error:function(e,t,s){sap.m.MessageBox.error("Failed to start workflow: "+e.responseText)}})}).catch(e=>{sap.m.MessageBox.error("Error saving travel request: "+e.message)}).finally(()=>{this.getView().setBusy(false);this.onPreviousStep()})}}})});
//# sourceMappingURL=ReviewTravelScreen.controller.js.map